<!DOCTYPE html>
<!-- Built with spec-md https://spec-md.com -->
<html>
<head><meta charset="utf-8">
<title>HertzScript Systems Specification</title>
<style>body {
  color: #333333;
  font: 13pt/18pt Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  margin: 6rem auto 3rem;
  max-width: 780px;
}

/* Selections */

.outdated-selection-link,
.selection-link {
  position: absolute;
  display: block;
  color: #fff;
  background: #cacee0;
  border-radius: 4px;
  font-size: 36px;
  height: 23px;
  line-height: 48px;
  text-align: center;
  text-decoration: none;
  width: 25px;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.outdated-selection-link:hover,
.selection-link:hover {
  text-decoration: none;
}

.outdated-selection-link:before,
.selection-link:before {
  border: 5px solid transparent;
  border-left-color: #cacee0;
  border-right: 0;
  content: '';
  height: 0;
  margin-top: -5px;
  margin-right: -5px;
  position: absolute;
  right: 1px;
  top: 50%;
  width: 0;
}

.selection-link:hover {
  background: #3b5998;
}

.selection-link:hover:before {
  border-left-color: #3b5998;
}

.outdated-selection-link {
  background: #f0babe;
  font-size: 21px;
  font-weight: 800;
  line-height: 27px;
}

.outdated-selection-link:before {
  border-left-color: #f0babe;
}

.outdated-selection-link:hover:after {
  content: "This selection content has changed since this link was created.";
  font: 9pt/11pt Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  position: absolute;
  display: block;
  white-space: nowrap;
  padding: 2px 5px 1px;
  top: -20px;
  background: black;
  color: white;
}

/* Links */

a {
  color: #3B5998;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}


/* Section headers */

h1, h2, h3, h4, h5, h6, h7, h8 {
  font-weight: bold;
  margin: 3em 0 1em;
  position: relative;
}

h1 {
  font-size: 1.5em;
  margin: 6em 0 3em;
}

h2 {
  font-size: 1.5em;
  margin-top: 5em;
}

h3, h4 {
  font-size: 1.25em;
}

h5, h6 {
  font-size: 1em;
}

section.subsec > h6 {
  margin-top: 2em;
}

section.subsec > h6 > a {
  color: #333333;
}

section .spec-secid {
  margin-right: 1ex;
  position: absolute;
  right: 100%;
  text-align: right;
  white-space: nowrap;
}

footer {
  font-size: 75%;
  opacity: 0.5;
  text-align: center;
  margin-top: 12rem;
}


/* Table of contents */

.spec-toc {
  margin: 1rem 0 3rem;
}

.spec-toc .title {
  content: 'Contents';
  display: block;
  font-weight: bold;
  margin: 5em 0 1em;
}

.spec-toc .spec-secid {
  margin-right: 1ex;
}

.spec-toc ol {
  list-style: none;
  padding-left: 0;
}

.spec-toc ol ol {
  list-style: none;
  padding-left: 2ex;
}

.spec-toc li {
  position: relative;
  padding: 5px 0 0 30px;
  margin: -5px 0 0 -30px;
}

.spec-toc a {
  color: #333333;
}

.spec-toc a:hover {
  text-decoration: none;
}

.spec-toc a .spec-secid {
  color: #3B5998;
}

.spec-toc a:hover .spec-secid {
  text-decoration: underline;
}

.spec-toc .toggle {
  display: none;
}

.spec-toc .toggle + label {
  cursor: pointer;
  left: 10px;
  opacity: 1;
  padding: 3px 5px 3px 6px;
  position: absolute;
  top: 8px;
  transform: rotate(0deg);
  transition: all 0.18s ease-in-out;
}

.spec-toc .toggle + label:after {
  border-color: transparent transparent transparent #bbc;
  border-style: solid;
  border-width: 6px 0 6px 7px;
  content: ' ';
  display: block;
  height: 0;
  width: 0;
}

.spec-toc .toggle:checked + label {
  transform: rotate(90deg);
}

.spec-toc li:not(:hover) > .toggle:checked + label {
  opacity: 0;
}

.spec-toc .toggle:not(:checked) ~ ol {
  max-height: 0;
  overflow: hidden;
}


/* Sidebar */

.spec-sidebar-toggle {
  display: none;
}

.spec-sidebar-toggle + label {
  position: fixed;
  right: 0;
  top: 0;
  padding: 10px 15px;
  font-size: 30px;
  color: rgba(0,0,0,0.7);
  z-index: 2;
  cursor: pointer;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.spec-sidebar {
  display: none;
  position: fixed;
  right: 0;
  top: 0;
  width: 320px;
  font-size: 80%;
  overflow-y: scroll;
  height: 100%;
  padding: 0 0 5rem 30px;
  box-sizing: border-box;
  background: #f0f0f0;
}

.spec-sidebar {
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.spec-sidebar-toggle:checked ~ .spec-sidebar {
  display: block;
  box-shadow:
    -1px 0 rgba(0,0,0,0.12),
    -4px 0 8px -2px rgba(0,0,0,0.05);
}

.spec-sidebar .viewing > a:after {
  color: #8b9;
  content: '\2022';
  margin-left: 1ex;
}

@media (min-width: 1240px) {
  .spec-sidebar-toggle + label {
    display: none;
  }

  .spec-sidebar {
    display: block;
    box-shadow:
      inset 1px 0 rgba(0,0,0,0.05),
      inset 4px 0 8px -2px rgba(0,0,0,0.08) !important;
  }

  body {
    padding-right: 300px;
  }
}


/* Notes */

.spec-note {
  background: #FEFEF3;
  border-left: solid 4px #F4E925;
  margin: 1em -1em;
  min-width: 416px;
  padding: 1ex 1em 1ex calc(1em - 4px);
  width: -moz-fit-content;
  width: -webkit-fit-content;
  width: fit-content;
}

.spec-note > a:first-child {
  color: #6C6613;
  display: block;
  font: italic 11pt/18pt Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  opacity: 0.6;
  user-select: none;
}


/* Todos */

.spec-todo {
  color: #666666;
  margin: 1em 0 1em 5em;
  min-height: 1em;
}

.spec-todo::before {
  content: 'todo';
  display: block;
  float: left;
  margin-left: -5em;
  text-transform: uppercase;
}

/* Index table */

.spec-index ol {
  list-style-type: none;
  margin: 0 0 0 2rem;
  padding: 0;
  column-width: 210px;
  column-gap: 2rem;
}

.spec-index ol li {
  width: min-content;
}

/* Code */

code {
  background: #FAFAFA;
  font-family: Consolas, Monaco, monospace;
  font-size: 85%;
  font-weight: inherit;
  margin: -2px -1px;
  padding: 3px 3px;
  white-space: pre;
}

pre code {
  background: none;
  font-weight: inherit;
  margin: 0;
  padding: 0;
}

pre {
  background: #FAFAFA;
  border-left: solid 4px #E9E9E9;
  margin: 1em -1em;
  min-width: 40ch;
  padding: 1ex 1em 1ex calc(1em - 4px);
  width: -moz-fit-content;
  width: -webkit-fit-content;
  width: fit-content;
}

.spec-example {
  background: #FAFAFF;
  border-left: solid 4px #BBBBFF;
}

.spec-counter-example {
  background: #FFFAFA;
  border-left: solid 4px #FFBBBB;
}

.spec-example > a,
.spec-counter-example > a {
  display: block;
  font: italic 11pt/18pt Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  opacity: 0.6;
  user-select: none;
}

.spec-counter-example > a {
  color: #98593b;
}


/* Tables */

table {
  border-collapse: collapse;
}

th {
  background-color: #F9F9F9;
}

td, th {
  border: 1px solid #D0D0D0;
  padding: 0.4em;
  vertical-align: baseline;
}


/* Edits */

ins {
  background-color: rgba(0, 200, 30, 0.08);
  text-decoration: none;
}

del {
  background-color: rgba(200, 0, 0, 0.08);
}

.spec-added, .spec-removed {
  border-left: 4px solid;
  margin-left: -18px;
  padding-left: 14px;
}

.spec-added {
  border-color: #396;
}

.spec-removed {
  border-color: #933;
  text-decoration: line-through;
}


/* Values */

.spec-keyword {
  font-weight: bold;
}

.spec-string {
  font-family: Consolas, Monaco, monospace;
  font-size: 85%;
  white-space: pre;
}

var {
  font-style: italic;
}

*[data-name] {
  transition: 0.15s background ease-out;
  border-radius: 2px;
  padding: 0 3px;
  margin: 0 -3px;
}


/* Grammar semantics, algorithms and calls */

.spec-semantic,
.spec-algo {
  margin: 1rem 0 1rem 2rem;
}

.spec-semantic > .spec-rhs {
  display: inline-block;
  margin-left: 1ex;
}

.spec-semantic > .spec-nt::after,
.spec-algo > .spec-call:first-child::after {
  content: ':';
  font-style: normal;
  font-weight: bold;
  margin-left: 1ex;
}

.spec-semantic ol, .spec-semantic ol ol ol ol,
.spec-algo ol, .spec-algo ol ol ol ol {
  list-style-type: decimal;
}

.spec-semantic ol ol, .spec-semantic ol ol ol ol ol,
.spec-algo ol ol, .spec-algo ol ol ol ol ol {
  list-style-type: lower-alpha;
}

.spec-semantic ol ol ol, .spec-semantic ol ol ol ol ol ol,
.spec-algo ol ol ol, .spec-algo ol ol ol ol ol ol {
  list-style-type: lower-roman;
}

.spec-call > a {
  color: inherit;
}


/* Grammar productions */

.spec-production {
  margin: 1rem 0 1rem 2rem;
}

.spec-production > .spec-nt::after {
  content: ':';
  font-style: normal;
  font-weight: bold;
  margin: 0 1ex;
}

.spec-semantic.d2 > .spec-nt::after,
.spec-production.d2 > .spec-nt::after {
  content: '::';
}

.spec-semantic.d3 > .spec-nt::after,
.spec-production.d3 > .spec-nt::after {
  content: ':::';
}

.spec-rhs {
  margin-left: 2rem;
}

.spec-oneof {
  display: inline;
}

.spec-oneof::before {
  content: 'one of';
  font-style: normal;
  font-weight: bold;
}

.spec-oneof > table {
  margin-left: 2rem;
}

.spec-oneof .spec-rhs {
  border: none;
  margin: 0;
  padding: 0 0.5em;
  vertical-align: baseline;
}

.spec-rhs .spec-constrained:not(:first-child),
.spec-rhs .spec-quantified:not(:first-child),
.spec-rhs .spec-nt:not(:first-child),
.spec-rhs .spec-t:not(:first-child),
.spec-rhs .spec-rx:not(:first-child),
.spec-rhs .spec-prose:not(:first-child),
.spec-rhs .spec-empty:not(:first-child),
.spec-rhs .spec-lookahead:not(:first-child) {
  margin-left: 1ex;
}

.spec-condition {
  font-size: 85%;
}

.spec-condition::before {
  content: '[if '
}

.spec-condition.not::before {
  content: '[if not '
}

.spec-condition::after {
  content: ']'
}

.spec-empty,
.spec-prose {
  color: #666666;
}

.spec-nt {
  font-style: italic;
}

.spec-nt > a {
  color: inherit;
}

.spec-quantifiers,
.spec-params {
  font-size: 65%;
  font-style: normal;
  vertical-align: sub;
}

.spec-quantifier.list {
  color: #3348D3;
}

.spec-quantifier.optional {
  color: #83238E;
}

.spec-params,
.spec-condition {
  color: #1C7758;
}

.spec-params::before {
  content: '[';
}

.spec-params::after {
  content: ']';
}

.spec-quantifier:not(:last-child)::after,
.spec-param:not(:last-child)::after {
  color: #666666;
  content: ', ';
}

.spec-param.conditional::before {
  content: '?';
}

.spec-param.negated::before {
  content: '!';
}

.spec-t, .spec-rx {
  color: #333333;
  font-family: monospace;
  font-weight: bold;
}

.spec-butnot::before {
  color: #666666;
  content: 'but not';
  font-family: Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  font-weight: normal;
  margin-right: 1ex;
}

.spec-butnot > *:not(:first-child)::before {
  color: #666666;
  content: 'or';
  font-family: Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  font-weight: normal;
  margin-right: 1ex;
}

.spec-rhs .spec-oneof::before,
.spec-rhs .spec-butnot::before {
  margin-left: 1ex;
}

.spec-lookahead > * {
  margin: 0 !important;
}

.spec-lookahead > *:not(:first-child)::before {
  color: #666666;
  content: ', ';
  font-family: Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  font-style: normal;
  font-weight: normal;
}

.spec-lookahead::before {
  color: #666666;
  content: '[lookahead = ';
  font-family: Cambria, "Palatino Linotype", Palatino, "Liberation Serif", serif;
  font-style: normal;
  font-weight: normal;
}

.spec-lookahead.not::before {
  content: '[lookahead \2260  ';
}

.spec-lookahead.set::before {
  content: '[lookahead \2208  {';
  margin-right: 0;
}

.spec-lookahead.set.not::before {
  content: '[lookahead \2209  {';
}

.spec-lookahead.ntset::before {
  content: '[lookahead \2208  ';
  margin-right: 0;
}

.spec-lookahead.ntset.not::before {
  content: '[lookahead \2209  ';
}

.spec-lookahead::after {
  color: #666666;
  content: ']';
}

.spec-lookahead.set::after {
  content: '}]';
}
</style>
<style>/* Copied from node_modules/prismjs/themes/prism.css */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<script>(function(){var e,t=document.getElementsByTagName("style")[0].sheet;function n(){e&&(t.deleteRule(e),e=void 0)}document.documentElement.addEventListener("mouseover",(function(a){var u,d=a.target.attributes["data-name"];d&&(u=d.value,n(),e=t.insertRule('*[data-name="'+u+'"] { background: #FBF8D0; }',t.cssRules.length))})),document.documentElement.addEventListener("mouseout",n);})()</script>
<script>(function(){var e,n,t,o,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";function a(e){c(new URL(e.target.href))}function i(){c(window.location)}function c(e){var n=e.hash.match(/^#sel-([A-Za-z0-9-_]+)$/);if(n){o=n[1];var a=(t=function(e){for(var n=new Array(64),t=0;t<64;t++)n[r.charCodeAt(t)]=t;var o=0,a=m(),i=m(),c=m(),d=w(),l=i.pop(),f=u(a.concat(i)),h=c.pop(),g=u(a.concat(c)),v=document.createRange();return v.setStart(f,l),v.setEnd(g,h),v.isOutdated=void 0!==d&&d!==s(v.toString()),v;function w(){for(var t=0,r=0;o<e.length;){var a=n[e.charCodeAt(o++)];if(t|=(31&a)<<r,r+=5,a<32)return t}}function m(){var e=w();if(null!=e){for(var n=new Array(e),t=0;t<e;t++)n[t]=w();return n}}}(o)).getBoundingClientRect(),i=Math.max(20,Math.floor(.4*(window.innerHeight-a.height)));window.scrollTo(0,window.scrollY+a.y-i);var c=document.getSelection();c.empty(),c.addRange(t),d()}}function d(){n||(n=document.getElementsByTagName("article")[0]),e||(e=document.createElement("a"),document.body.appendChild(e)),e.href="#sel-"+o,e.onclick=a,e.className=t.isOutdated?"outdated-selection-link":"selection-link",e.innerText=t.isOutdated?"!":"â€Ÿ";var r=n.getBoundingClientRect().x,i=t.getBoundingClientRect().y;e.style.left=Math.floor(r+window.scrollX-37)+"px",e.style.top=Math.floor(i+window.scrollY-3)+"px"}function l(e){for(var n=[];e!=document.body;){var t=e.parentNode;n.push(Array.prototype.indexOf.call(t.childNodes,e)),e=t}return n.reverse()}function u(e){for(var n=document.body,t=0;t<e.length&&n;t++)n=n.childNodes[e[t]];return n}function s(e){for(var n=2166136261,t=0;t<e.length;++t)n^=e.charCodeAt(t),n+=(n<<1)+(n<<4)+(n<<7)+(n<<8)+(n<<24);return 32767&(n>>15^n)}document.addEventListener("selectionchange",(function(n){var a=document.getSelection();if(a.isCollapsed)e&&(e.parentNode.removeChild(e),e=null);else{var i=a.getRangeAt(0);t&&0===i.compareBoundaryPoints(Range.START_TO_START,t)&&0===i.compareBoundaryPoints(Range.END_TO_END,t)||(o=function(e){var n="",t=l(e.startContainer),o=l(e.endContainer),a=function(e,n){var t=0;for(;t<e.length&&t<n.length&&e[t]===n[t];)t++;return e.slice(0,t)}(t,o);return c(a),c(t.slice(a.length).concat(e.startOffset)),c(o.slice(a.length).concat(e.endOffset)),i(s(e.toString())),n;function i(e){do{n+=r[31&e|(e>31?32:0)],e>>=5}while(e>0)}function c(e){i(e.length);for(var n=0;n<e.length;n++)i(e[n])}}(t=i),d())}})),window.addEventListener("resize",d),window.addEventListener("hashchange",i),window.addEventListener("load",i);})()</script>
</head>
<body><article>
<header>
<h1>HertzScript Systems Specification</h1>
<section id="intro">
<section id="sec-WORK-IN-PROGRESS" class="subsec">
<h6><a href="#sec-WORK-IN-PROGRESS" title="link to this subsection">WORK IN PROGRESS</a></h6>
<div class="spec-todo">
Add sequence and dependency graphs.</div>
</section>
</section>
<nav class="spec-toc">
<div class="title">Contents</div>
<ol>
<li><a href="#sec-High-Level-Synopsis"><span class="spec-secid">1</span>High-Level Synopsis</a>
<input hidden class="toggle" type="checkbox" checked id="_toggle_1" /><label for="_toggle_1"></label>
<ol>
<li><a href="#sec-Overview-of-Components"><span class="spec-secid">1.1</span>Overview of Components</a></li>
</ol>
</li>
<li><a href="#sec-Theory-of-Operation"><span class="spec-secid">2</span>Theory of Operation</a>
<input hidden class="toggle" type="checkbox" checked id="_toggle_2" /><label for="_toggle_2"></label>
<ol>
<li><a href="#sec-Compiler"><span class="spec-secid">2.1</span>Compiler</a></li>
<li><a href="#sec-Function-Detours"><span class="spec-secid">2.2</span>Function Detours</a></li>
<li><a href="#sec-Instruction-Tokens"><span class="spec-secid">2.3</span>Instruction Tokens</a></li>
<li><a href="#sec-Virtual-Machine"><span class="spec-secid">2.4</span>Virtual Machine</a></li>
<li><a href="#sec-Dispatcher"><span class="spec-secid">2.5</span>Dispatcher</a></li>
<li><a href="#sec-Programming-Environment"><span class="spec-secid">2.6</span>Programming Environment</a></li>
</ol>
</li>
</ol>
</nav>
</header>
<section id="sec-High-Level-Synopsis" secid="1">
<h2><span class="spec-secid" title="link to this section"><a href="#sec-High-Level-Synopsis">1</a></span>High-Level Synopsis</h2>
<p>HertzScript (abbreviated &ldquo;HzScript&rdquo;) transforms JavaScript functions into stackless coroutines which can be preempted, and provides a degree of concurrency which is more fine&#8208;grained than traditional JavaScript. Normal functions must run from beginning to end due to the single&#8208;threaded nature of JavaScript, but HertzScript allows you to automatically preempt and context switch between several functions; software developers may utilize this concurrency via a new <code>spawn</code> keyword. If you call a function which is preceded by the <code>spawn</code> keyword, then the function will run concurrently alongside any other functions and the caller function.</p>
<p>Coroutines are normally reserved for cooperative multitasking, but HertzScript implements a special variant called voluntary preemptive multitasking. In regular cooperative programs the software developer must manually declare the points at which programs will yield, and HertzScript extends that concept by automating it at every function call and loop.</p>
<section id="sec-Overview-of-Components" secid="1.1">
<h3><span class="spec-secid" title="link to this section"><a href="#sec-Overview-of-Components">1.1</a></span>Overview of Components</h3>
<p>HertzScript is composed of layered abstracting and interoperating systems including a compiler, virtual machine, multitasking dispatcher, and programming environment. Each component can be used either independently or as part of a higher&#8208;level abstracting component. The lowest&#8208;level foundational components are the compiler and the virtual machine.</p>
<p><img src="http://g.gravizo.com/svg?%0A%09digraph%20Components%20%7B%0A%09%09Compiler%20%5Bshape=box%5D;%0A%09%09VirtualMachine%20%5Bshape=box%5D;%0A%09%09Dispatcher%20%5Bshape=box%5D;%0A%09%09Environment%20%5Bshape=box%5D;%0A%09%09Compiler%20-%3E%20VirtualMachine;%0A%09%09VirtualMachine%20-%3E%20Dispatcher;%0A%09%09Dispatcher%20-%3E%20Environment;%0A%09%09%7B%0A%09%09%09rank=same;%20Compiler%20VirtualMachine%20Dispatcher%20Environment%0A%09%09%7D%0A%09%7D%0A" alt="Component Diagram"/></p>
</section>
</section>
<section id="sec-Theory-of-Operation" secid="2">
<h2><span class="spec-secid" title="link to this section"><a href="#sec-Theory-of-Operation">2</a></span>Theory of Operation</h2>
<section id="sec-Compiler" secid="2.1">
<h3><span class="spec-secid" title="link to this section"><a href="#sec-Compiler">2.1</a></span>Compiler</h3>
<p>The HertzScript compiler uses a multi&#8208;stage source&#8208;to&#8208;source compilation pipeline to transform JavaScript functions into instruction streams; all functions within a HzScript program are GeneratorFunctions which yield instructions. Residing the bottom abstraction level of the system, the HertzScript compiler serves as a fundamental mechanism in the creation of re&#8208;entrant programs.</p>
<p>The first stage in the compilation pipeline consists of Acorn, an Acorn parser plugin, and Acorn&#8208;Walk, which are used to parse and transform any <code>SpawnExpression</code> to a regular method call for Babel to recognize in the second stage. <code>spawn</code> is a contextual keyword which could also be a regular method call and not a <code>SpawnExpression</code>, so the parser looks for any instance of the <code>spawn</code> keyword followed by any number of spaces and an identifier character.</p>
<p>The second stage consists of Babel and a Babel transformation plugin which is used to transform all function expressions/statements into GeneratorFunctions, and wrap all functions in detour hooking functions. Within the new GeneratorFunctions all CallExpressions, NewExpressions, ReturnStatements, YieldExpressions, and SpawnExpressions are transformed into yielded instruction tokens. A special token named <code>loopYield</code> is added to the beginning of each loop to ensure that they are interruptable.</p>
</section>
<section id="sec-Function-Detours" secid="2.2">
<h3><span class="spec-secid" title="link to this section"><a href="#sec-Function-Detours">2.2</a></span>Function Detours</h3>
<p>The Babel transformation plugin wraps all functions and function calls in detouring functions, and the detour library is a collection of function hooks designed to detour specific types of functions.</p>
<ul>
<li><code>hookCoroutine</code> detours a function.</li>
<li><code>hookArrowCoroutine</code> detours an <code>ArrowFunctionExpression</code>.</li>
<li><code>hookGenerator</code> detours a <code>GeneratorFunction</code>.</li>
<li><code>hookIterator</code> detours an iterator interface object&rsquo;s <code>next</code>, <code>return</code>, and <code>throw</code> methods.</li>
</ul>
<p>All detours insert a hooking function which replaces the original function with a special invocation adapter. Upon invoking the adapter a new HertzScript virtual machine is started in&#8208;place, and the original function is run from within it. The original function is assigned to a Symbol property named <code>tokenSym</code>. Each hook marks the detour and original function with special markers symbols which allow the virtual machine to observe information that would originally only be visible at compile&#8208;time.</p>
<ul>
<li><code>tokenSym</code> is assigned as a property which points to the original function.</li>
<li><code>crtSym</code> marks a function as a coroutine.</li>
<li><code>conSym</code> marks a function as a constructor coroutine.</li>
<li><code>genSym</code> marks a function as a generator.</li>
<li><code>iterSym</code> marks a function as belonging to an iterator interface object.</li>
</ul>
</section>
<section id="sec-Instruction-Tokens" secid="2.3">
<h3><span class="spec-secid" title="link to this section"><a href="#sec-Instruction-Tokens">2.3</a></span>Instruction Tokens</h3>
<p>The HertzScript instruction set is a list of &ldquo;instruction tokens&rdquo; and is composed of Kernelizer objects, which are generic objects designed to safely wrap user data. Some instruction tokens accept arguments in an array which are assigned to properties in itself via a <code>set</code> method. All tokens are gauranteed to only be in&#8208;use during 1 cycle because the virtual machine executes in a single thread, and so each instruction token is a single&#8208;instance uniqueness type to reduce memory overhead.</p>
<p>All instruction tokens are marked by having a special symbol assigned to them called <code>kernSym</code>, and if the virtual machine determines that an object has the symbol as a property then it assumes that the object is an instruction token and attempts to process it.</p>
<p>Instruction tokens are classified by two types:</p>
<p><code>loopYield</code> is a special token which is used to interrupt loops, and does not wrap user datum or invoke any functions.</p>
<ol>
<li><strong>Invocation Tokens</strong> wrap userland functors and any operands needed to invoke them.</li>
<li><code>call</code> &amp; <code>callArgs</code> invoke a function with and without arguments.</li>
<li><code>callMethod</code> &amp; <code>callMethodArgs</code> invoke a method.</li>
<li><code>new</code> &amp; <code>newArgs</code> invoke a constructor.</li>
<li><code>newMethod</code> &amp; <code>newMethodArgs</code> invoke a constructor from a method.</li>
<li><code>spawn</code> &amp; <code>spawnArgs</code> spawn a new coroutine.</li>
<li><code>spawnMethod</code> &amp; <code>spawnMethodArgs</code> spawn a new corotuine from a method.</li>
<li><strong>Data Tokens</strong> wrap arbitrary userland datum, such as for <code>return</code> and <code>yield</code>.</li>
<li><code>return</code> &amp; <code>returnValue</code> wraps a <code>return</code>.</li>
<li><code>yield</code> &amp; <code>yieldValue</code> wraps a <code>yield</code>.</li>
</ol>
</section>
<section id="sec-Virtual-Machine" secid="2.4">
<h3><span class="spec-secid" title="link to this section"><a href="#sec-Virtual-Machine">2.4</a></span>Virtual Machine</h3>
<p>To facilitate the aforementioned instruction stream transformations while preserving normal JavaScript execution, the HertzScript virtual machine implements the behaviors indicated by the instruction set and executes the compiled source code. The virtual machine consumes the instructions which are yielded by the compiled source code, performing the appropriate operations in response to each instruction. The HertzScript virtual machine is written in regular JavaScript which executes within the JavaScript virtual machine.</p>
<p>The HertzScript virtual machine changes how the JavaScript virtual machine call stack is utilized. When a new coroutine is started, a new Coroutine Control Block is created for it which contains a virtual call stack, and the HertzScript instruction set corresponds with operations which push and pop the coroutines in that stack. Only the currently executing coroutine will reside within the JavaScript VM call stack.</p>
<p>The JavaScript VM call stack does not grow past the currently running coroutine except during function calls which were initiated by many of JavaScript&rsquo;s standard operators which are not the invocation operator, loosely limiting the VM call stack to a set length. The end result of this size reduction is that all coroutines are generally able to perform a context switch with <code>O(1)</code> time complexity, significantly reducing any possible jitter that would critically impact multitasking operation.</p>
</section>
<section id="sec-Dispatcher" secid="2.5">
<h3><span class="spec-secid" title="link to this section"><a href="#sec-Dispatcher">2.5</a></span>Dispatcher</h3>
<p>The HertzScript dispatcher is a concurrency control system and preemptive multitasking kernel. The dispatcher is responsible for the supervision, scheduling, dispatchment, preemption, and context switching of multiple different HertzScript virtual machines within a single thread.</p>
</section>
<section id="sec-Programming-Environment" secid="2.6">
<h3><span class="spec-secid" title="link to this section"><a href="#sec-Programming-Environment">2.6</a></span>Programming Environment</h3>
<p>TBD </p>
</section>
</section>
</article>
<footer>
Written in <a href="https://spec-md.com" target="_blank">Spec Markdown</a>.</footer>
<input hidden class="spec-sidebar-toggle" type="checkbox" id="spec-sidebar-toggle" aria-hidden /><label for="spec-sidebar-toggle" aria-hidden>&#x2630;</label>
<div class="spec-sidebar" aria-hidden>
<div class="spec-toc">
<div class="title"><a href="#">HertzScript Systems Specification</a></div>
<ol><li id="_sidebar_1"><a href="#sec-High-Level-Synopsis"><span class="spec-secid">1</span>High-Level Synopsis</a>
<input hidden class="toggle" type="checkbox" id="_sidebar_toggle_1" /><label for="_sidebar_toggle_1"></label>
<ol>
<li id="_sidebar_1.1"><a href="#sec-Overview-of-Components"><span class="spec-secid">1.1</span>Overview of Components</a></li>
</ol>
</li>
<li id="_sidebar_2"><a href="#sec-Theory-of-Operation"><span class="spec-secid">2</span>Theory of Operation</a>
<input hidden class="toggle" type="checkbox" id="_sidebar_toggle_2" /><label for="_sidebar_toggle_2"></label>
<ol>
<li id="_sidebar_2.1"><a href="#sec-Compiler"><span class="spec-secid">2.1</span>Compiler</a></li>
<li id="_sidebar_2.2"><a href="#sec-Function-Detours"><span class="spec-secid">2.2</span>Function Detours</a></li>
<li id="_sidebar_2.3"><a href="#sec-Instruction-Tokens"><span class="spec-secid">2.3</span>Instruction Tokens</a></li>
<li id="_sidebar_2.4"><a href="#sec-Virtual-Machine"><span class="spec-secid">2.4</span>Virtual Machine</a></li>
<li id="_sidebar_2.5"><a href="#sec-Dispatcher"><span class="spec-secid">2.5</span>Dispatcher</a></li>
<li id="_sidebar_2.6"><a href="#sec-Programming-Environment"><span class="spec-secid">2.6</span>Programming Environment</a></li>
</ol>
</li>
</ol>
</div>
<script>(function(){for(var e,t=[],n=document.getElementsByTagName("section"),o=0;o<n.length;o++)n[o].getAttribute("secid")&&t.push(n[o]);var i=window.scrollY,r=!1;function c(n){for(var o,i=n+document.documentElement.clientHeight/4,r=t.length-1;r>=0;r--)if(t[r].offsetTop<i){o=t[r];break}var c=o&&o.getAttribute("secid");c!==e&&(e&&d(e,!1),c&&d(c,!0),e=c)}function d(e,t){document.getElementById("_sidebar_"+e).className=t?"viewing":"";for(var n=e.split(".");n.length;){var o=document.getElementById("_sidebar_toggle_"+n.join("."));o&&(o.checked=t),n.pop()}}window.addEventListener("scroll",(function(e){i=window.scrollY,r||(r=!0,window.requestAnimationFrame((function(){c(i),r=!1})))})),c(window.scrollY);})()</script>
</div>
</body>
</html>
